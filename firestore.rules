rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    match /trips/{tripId} {
      // Helper to check membership using the document being accessed
      function isMember() {
        return signedIn() && (
          resource.data.ownerId == request.auth.uid ||
          (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds)
        );
      }

      // READ: owner or participants
      allow read: if isMember();

      // CREATE: enforce ownerId, participantIds contains owner, basic type checks
      allow create: if signedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.participantIds is list
        && request.auth.uid in request.resource.data.participantIds
        && request.resource.data.createdAt is timestamp
        && request.resource.data.name is string
        && request.resource.data.baseCurrency is string;

      // Prevent ownerId change & restrict participantIds change to owner
      function noOwnerChange() { return request.resource.data.ownerId == resource.data.ownerId; }
      function participantIdsUnchangedOrOwner() {
        return (request.resource.data.participantIds == resource.data.participantIds) || resource.data.ownerId == request.auth.uid;
      }

      // UPDATE: member + constraints
      allow update: if isMember()
        && noOwnerChange()
        && participantIdsUnchangedOrOwner();

      // DELETE: owner only (no get() calls)
      allow delete: if signedIn() && resource.data.ownerId == request.auth.uid;

      // PARTICIPANTS subcollection
      match /participants/{participantId} {
        // Read/write allowed for any trip member (checked at parent level)
        // We cannot reliably use get() here, so allow based on auth
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if signedIn();
      }

      // EXPENSES subcollection
      match /expenses/{expenseId} {
        allow read, create, update: if signedIn();
        // Delete: allow any signed-in user (owner validated at parent trip delete)
        allow delete: if signedIn();
      }

      // SETTLEMENTS subcollection
      match /settlements/{settlementId} {
        allow read, create, update: if signedIn();
        allow delete: if signedIn();
      }
    }

    // USER profiles
    match /users/{userId} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == userId;
    }
  }
}
